(function(){var e,t,n,r,i=[].slice,s={}.hasOwnProperty,o=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};e=typeof window!="undefined"&&window!==null?window.Backbone.Events:require("backbone").Events,n=function(t){var n,r,i;i=[];for(n in e)r=e[n],i.push(t[n]=r);return i},t={},t.Message=function(){function e(e,t,n){e==null&&(e=""),t==null&&(t=void 0),this.options=n!=null?n:{},this._hidden=t&&this.options.store==="cookie"&&typeof cookie!="undefined"&&cookie!==null?cookie.get("noted_"+t+"_hidden")||!1:t&&this.options.store==="store"&&typeof store!="undefined"&&store!==null?store.get("noted_"+t+"_hidden")||!1:!1,this.setBody(e),this.setId(t),this.listenTo(this,"hide",this._hide)}return e.prototype.getBody=function(){return this.body},e.prototype.setBody=function(e){this.body=e},e.prototype.delivered=!1,e.prototype.isDelivered=function(){return this.delivered},e.prototype.setDelivered=function(e){this.delivered=e!=null?e:!0},e.prototype.getId=function(){return this._id},e.prototype.setId=function(e){this._id=e},e.prototype.isHidden=function(){return this._hidden},e.prototype.hide=function(e){return this.trigger("hide",e)},e.prototype._hide=function(e,t){t==null&&(t=!1),this._hidden=!0;if(t)return;if(this.options.store==="cookie"&&typeof cookie!="undefined"&&cookie!==null)return cookie.set("noted_"+this.getId()+"_hidden",!0);if(this.options.store==="store"&&typeof store!="undefined"&&store!==null)return store.set("noted_"+this.getId()+"_hidden",!0)},e}(),n(t.Message.prototype),t.Message.prototype.trigger=function(){var t,n,r;return n=arguments[0],t=2<=arguments.length?i.call(arguments,1):[],(r=e.trigger).call.apply(r,[this,n,this].concat(i.call(t)))},t.Event=function(){function e(e,t){this.group=e,this.name=t,this._messages=[]}return e.prototype.getName=function(){return this.name},e.prototype.getMessages=function(){return this._messages},e.prototype.add=function(e){return this._messages.push(e)},e.prototype.getGroup=function(){return this.group},e.prototype.setGroup=function(e){this.group=e},e}(),n(t.Event.prototype),t.EventGroup=function(){function e(e){this.name=e,this._eventObjs={}}return e.prototype.getName=function(){return this.name},e.prototype.add=function(e){return e instanceof t.Event?(this._eventObjs[e.getName()]=e,e.setGroup(this),e):this._eventObjs[e]=new t.Event(this,e)},e.prototype.all=function(){var e,t,n,r;n=[],r=this._eventObjs;for(t in r)e=r[t],n.push(e);return n},e.prototype.get=function(e){return this._eventObjs[e]},e.prototype.remove=function(e){var n;return n=e instanceof t.Event?e.name:e,delete this._eventObjs[n]},e}(),n(t.EventGroup.prototype),t.Broker=function(){function e(){this._eventGroups={}}return e.prototype.subscribe=function(e,t,n,r){var s,o,u,a,f,l,c,h,p,d,v,m,g,y;r==null&&(r={}),s=this.get(e),a=function(){var n;return n=1<=arguments.length?i.call(arguments,0):[],e=typeof n[0]=="string"?n[1]:n[0],e.setDelivered(),t.apply(this,n)},a._callback=t;if(r.delayed)if(s.getName()==="all"){v=this._eventGroups;for(u in v){o=v[u],m=o.all();for(f=0,h=m.length;f<h;f++){s=m[f],g=s.getMessages();for(l=0,p=g.length;l<p;l++)e=g[l],(!r.undelivered||!e.isDelivered())&&!e.isHidden()&&a.call(n,s.getName(),e)}}}else{y=s.getMessages();for(c=0,d=y.length;c<d;c++)e=y[c],(!r.undelivered||!e.isDelivered())&&!e.isHidden()&&a.call(n,e)}return s.getGroup().on(s.getName(),a,n)},e.prototype.publish=function(e,n,r){var i,s,o,u,a;return r==null&&(r={}),a=this.parse(e),u=a[0],u=a[1],o=a[2],i=this.get(e),e=new t.Message(n,o,r),i.add(e),e.isHidden()||i.getGroup().trigger(i.getName(),e),r.hideAfter&&(s=function(){return e.hide(r.storeHide?!r.storeHide:void 0)},setTimeout(s,r.hideAfter)),e},e.prototype.unsubscribe=function(e,t,n){var r,i,s,o,u;if(e)return r=this.get(e),r.getGroup().off(r.getName(),t,n);o=this._eventGroups,u=[];for(s in o)i=o[s],u.push(i.off(null,t,n));return u},e.prototype.get=function(e){var n,r,i,s,o,u;return u=this.parse(e),i=u[0],n=u[1],s=u[2],r=(o=this._eventGroups)[i]||(o[i]=new t.EventGroup(i)),r.get(n)||r.add(n)},e.prototype.parse=function(e){var t,n,r,i;return i=e.match(/(?:(.+):|)([^#]*)(?:#(.+)|)/).slice(1),n=i[0],t=i[1],r=i[2],[n,t||"all",r]},e}(),t.MessagesList=function(){function e(e,t){this._messages=[],this._events={},n(this._events),this.setBroker(e),this.setContext(t)}return e.prototype.getBroker=function(){return this.broker},e.prototype.setBroker=function(e){this.broker=e},e.prototype.getContext=function(){return this.context},e.prototype.setContext=function(e){this.context=e},e.prototype.getMessages=function(){return this._messages},e.prototype.store=function(e){var t;return this._messages.push(e),t=function(){var e,t,n;return t=arguments[0],e=2<=arguments.length?i.call(arguments,1):[],(n=this._events).trigger.apply(n,[t].concat(i.call(e)))},e.on("all",t,this),e},e.prototype.trigger=function(){var e,t,n,r,s,o,u,a,f,l,c,h;s=arguments[0],r=arguments[1],n=3<=arguments.length?i.call(arguments,2):[],typeof s=="string"?(a={},t=s,e=[r].concat(n)):(a=s,t=r,e=n),u=function(){var e,t,n;if(a.hidden)return this._messages;f=[],n=this._messages;for(e=0,t=n.length;e<t;e++)o=n[e],o.isHidden()||f.push(o);return f}.call(this),h=[];for(l=0,c=u.length;l<c;l++)o=u[l],h.push(o.trigger.apply(o,[t].concat(i.call(e))));return h},e.prototype.on=function(e,t){return this._events.on(e,t,this.context)},e.prototype.off=function(e,t){return this._events.off(e,t)},e}(),t.Emitter=function(e){function t(){return r=t.__super__.constructor.apply(this,arguments),r}return o(t,e),t.prototype.emit=function(e,t,n){return e=this.broker.publish(e,t,n),this._messages.push(e),e},t}(t.MessagesList),t.Receiver=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return o(t,e),t.prototype.listen=function(e,t,n){var r,s;return n==null&&(n={}),r=this,s=function(){var e,n;return n=arguments[0],e=2<=arguments.length?i.call(arguments,1):[],r._messages.push(n),t.apply(this,arguments)},t._callback=s,this.broker.subscribe(e,s,this.context,n)},t.prototype.stop=function(e,t){return this.broker.unsubscribe(e,(t!=null?t._callback:void 0)||t,this.context)},t}(t.MessagesList),typeof window!="undefined"&&window!==null?window.Noted=t:module.exports=t}).call(this);